environment:

  BINSTAR_TOKEN:
    # Generated with "anaconda auth --create --name conda-recipes-scitools-2016 -o SciTools" and
    # encrypted on ci.appveyor.com/tools/encrypt.
    secure: vEXaxIcVqImAv8mMqEGotj4Mym4uLVkHhf3jlksGimFJ88RcaF/hxdEUSt6HTxPr

  matrix:
    - TARGET_ARCH: x64
      PY_CONDITION: "python >=2.7,<3"
      CONDA_INSTALL_LOCN: C:\\Miniconda-x64

    - TARGET_ARCH: x64
      PY_CONDITION: "python >=3.4,<3.5"
      CONDA_INSTALL_LOCN: C:\\Miniconda35-x64

    - TARGET_ARCH: x64
      PY_CONDITION: "python >=3.5,<3.6"
      CONDA_INSTALL_LOCN: C:\\Miniconda35-x64

    - TARGET_ARCH: x64
      PY_CONDITION: "python >=3.6,<3.7"
      CONDA_INSTALL_LOCN: C:\\Miniconda36-x64

    - TARGET_ARCH: x86
      PY_CONDITION: "python >=2.7,<3"
      CONDA_INSTALL_LOCN: C:\\Miniconda

    - TARGET_ARCH: x86
      PY_CONDITION: "python >=3.4,<3.5"
      CONDA_INSTALL_LOCN: C:\\Miniconda35

    - TARGET_ARCH: x86
      PY_CONDITION: "python >=3.5,<3.6"
      CONDA_INSTALL_LOCN: C:\\Miniconda35

    - TARGET_ARCH: x86
      PY_CONDITION: "python >=3.6,<3.7"
      CONDA_INSTALL_LOCN: C:\\Miniconda36

# We always use a 64-bit machine, but can build x86 distributions
# with the TARGET_ARCH variable (which is used by CMD_IN_ENV).
platform:
  - x64

install:
  # If there is a newer build queued for the same PR cancel the previous one.
  - ps: if ($env:APPVEYOR_PULL_REQUEST_NUMBER -and $env:APPVEYOR_BUILD_NUMBER -ne ((Invoke-RestMethod `
      https://ci.appveyor.com/api/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG/history?recordsNumber=50).builds | `
      Where-Object pullRequestId -eq $env:APPVEYOR_PULL_REQUEST_NUMBER)[0].buildNumber) { `
        throw "There are newer queued builds for this pull request, failing early." }

  # Remove cygwin (and therefore the git that comes with it).
  - cmd: rmdir C:\cygwin /s /q
  - setlocal enableextensions enabledelayedexpansion

  # Add path, activate `conda` and update conda.
  - cmd: call %CONDA_INSTALL_LOCN%\Scripts\activate.bat
  - cmd: conda update -n root --yes conda
  - cmd: conda install -n root --yes conda-build-all
  # https://github.com/SciTools/conda-build-all/issues/79
  - cmd: conda install -n root --yes conda=4.2.16

  # Needed for building extensions in python2.7 x64 with cmake.
  - cmd: conda install -n root --yes -c conda-forge vs2008_express_vc_python_patch
  - cmd: call setup_x64

  # Add our channels.
  - cmd: conda config --set show_channel_urls true
  - cmd: conda config --add channels scitools

  # 2 cores available on Appveyor workers: https://www.appveyor.com/docs/build-configuration/#build-environment
  # CPU_COUNT is passed through conda build: https://github.com/conda/conda-build/pull/1149
  - cmd: set CPU_COUNT=2
  - cmd: set PYTHONUNBUFFERED=1

  - cmd: conda info

# Skip .NET project specific build phase.
build: off

test_script:
    - cmd: if not "%BINSTAR_TOKEN%" == "" (set UPLOAD=--upload-channels scitools) else (set UPLOAD=)
    - 'conda-build-all .\ %UPLOAD% --inspect-channels scitools/label/main --matrix-conditions "numpy >=1.8,<=1.10" "%PY_CONDITION%"'
